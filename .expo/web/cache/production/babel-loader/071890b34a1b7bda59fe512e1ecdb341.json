{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";import _inherits from\"@babel/runtime/helpers/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import React from'react';import View from\"react-native-web/dist/exports/View\";import TouchableHighlight from\"react-native-web/dist/exports/TouchableHighlight\";import Image from\"react-native-web/dist/exports/Image\";import Text from\"react-native-web/dist/exports/Text\";import ScrollView from\"react-native-web/dist/exports/ScrollView\";import Platform from\"react-native-web/dist/exports/Platform\";import Alert from\"react-native-web/dist/exports/Alert\";import Dimensions from\"react-native-web/dist/exports/Dimensions\";import{connect}from'react-redux';import*as ImagePicker from'expo-image-picker';import*as Permissions from'expo-permissions';import{bindActionCreators}from'redux';import{updateProfilePicture,fetchStudentsSuccess,editStudentSuccess}from\"../../../redux/school/actions/index\";import{get,post,delete_by_id}from\"../../util\";import Modal from\"./modal\";import EditStudentProfile from\"./editstudentprofile\";import AddParent from\"./addparent\";import QRPage from\"./qrpage\";var _Dimensions$get=Dimensions.get('window'),width=_Dimensions$get.width,height=_Dimensions$get.height;var Students=function(_React$Component){_inherits(Students,_React$Component);var _super=_createSuper(Students);function Students(props){var _this;_classCallCheck(this,Students);_this=_super.call(this,props);_this.getPermissionAsync=function _callee(){var _await$Permissions$as,status;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(Platform.OS==='ios')){_context.next=6;break;}_context.next=3;return _regeneratorRuntime.awrap(Permissions.askAsync(Permissions.CAMERA_ROLL));case 3:_await$Permissions$as=_context.sent;status=_await$Permissions$as.status;if(status!=='granted'){alert('Sorry, we need camera roll permissions to make this work!');}case 6:case\"end\":return _context.stop();}}},null,null,null,Promise);};_this._pickImage=function _callee2(student_id,url){var result,base64;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return _regeneratorRuntime.awrap(ImagePicker.launchImageLibraryAsync({mediaTypes:ImagePicker.MediaTypeOptions.All,allowsEditing:true,aspect:[1,1],quality:0.4,base64:true}));case 3:result=_context2.sent;if(!result.cancelled){base64=result.base64;_this.getProfilePictureURL(base64,student_id,url);}_context2.next=10;break;case 7:_context2.prev=7;_context2.t0=_context2[\"catch\"](0);console.log(_context2.t0);case 10:case\"end\":return _context2.stop();}}},null,null,[[0,7]],Promise);};_this.state={showModal:false,modal_type:'',student_id:'',parent_data:{},qr_data:'',modal_padding:0};return _this;}_createClass(Students,[{key:\"componentDidMount\",value:function componentDidMount(){this.getPermissionAsync();}},{key:\"getProfilePictureURL\",value:function getProfilePictureURL(image,student_id,url){var school_name,students,body,response,success,statusCode,message,data;return _regeneratorRuntime.async(function getProfilePictureURL$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:school_name=this.props.route.params.school_name;students=this.props.students;body={image:image,url:url,path:school_name+\"/profile_picture_\"+student_id+\"_\"+new Date().getMilliseconds()+\".jpg\"};_context3.next=5;return _regeneratorRuntime.awrap(post(\"/student/\"+student_id+\"/profile-picture\",body));case 5:response=_context3.sent;success=response.success,statusCode=response.statusCode,message=response.message,data=response.data;if(success){_context3.next=10;break;}alert(\"Sorry \"+students[student_id].name+\"\\u7167\\u7247\\u4E0A\\u50B3\\u6642\\u96FB\\u8166\\u51FA\\u72C0\\u6CC1\\u4E86\\uFF01\\u8ACB\\u622A\\u5716\\u548C\\u8207\\u5DE5\\u7A0B\\u5E2B\\u806F\\u7E6B\\n\\n\"+message);return _context3.abrupt(\"return\");case 10:this.props.updateProfilePicture(student_id,data.image_url);case 11:case\"end\":return _context3.stop();}}},null,this,null,Promise);}},{key:\"getModalContent\",value:function getModalContent(){var _this2=this;var _this$props=this.props,students=_this$props.students,classes=_this$props.classes;var _this$state=this.state,showModal=_this$state.showModal,modal_type=_this$state.modal_type,student_id=_this$state.student_id,parent_data=_this$state.parent_data,qr_data=_this$state.qr_data;if(!showModal){return null;}else if(modal_type==='student'){return React.createElement(EditStudentProfile,{student_id:student_id,student:students[student_id],classes:classes,addParent:function addParent(parent_data){return _this2.setState({modal_type:'add_parent',parent_data:parent_data});},editStudentSuccess:function editStudentSuccess(student_id,name,old_class_id,class_id){return _this2.props.editStudentSuccess(student_id,name,old_class_id,class_id);},hideModal:function hideModal(){return _this2.hideModal();}});}else if(modal_type==='add_parent'){return React.createElement(AddParent,{student_id:student_id,parent_data:parent_data,viewQRCode:function viewQRCode(qr_data){return _this2.setState({modal_type:'qrpage',qr_data:qr_data});},goBack:function goBack(){return _this2.setState({modal_type:'student'});}});}else{return React.createElement(QRPage,{qr_data:qr_data,student_name:students[student_id].name,parent_data:parent_data,goBack:function goBack(){return _this2.setState({modal_type:'add_parent'});}});}}},{key:\"hideModal\",value:function hideModal(){this.setState({showModal:false});}},{key:\"confirmDeleteStudent\",value:function confirmDeleteStudent(student_id){var _this3=this;var students=this.props.students;Alert.alert(students[student_id].name+\" \\u522A\\u9664\\u78BA\\u8A8D\",'刪除這個寶貝會將一切攸關資料(包誇父母)刪除',[{text:\"取消\",style:\"cancel\"},{text:'OK',onPress:function onPress(){return _this3.deleteStudentById(student_id);}}]);}},{key:\"deleteStudentById\",value:function deleteStudentById(student_id){var students,response,success,statusCode,message,data;return _regeneratorRuntime.async(function deleteStudentById$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:students=this.props.students;_context4.next=3;return _regeneratorRuntime.awrap(delete_by_id(\"/student/\"+student_id+\"/\"));case 3:response=_context4.sent;success=response.success,statusCode=response.statusCode,message=response.message,data=response.data;if(success){_context4.next=8;break;}alert(\"Sorry \"+students[student_id].name+\"\\u7167\\u7247\\u4E0A\\u50B3\\u6642\\u96FB\\u8166\\u51FA\\u72C0\\u6CC1\\u4E86\\uFF01\\u8ACB\\u622A\\u5716\\u548C\\u8207\\u5DE5\\u7A0B\\u5E2B\\u806F\\u7E6B\\n\\n\"+message);return _context4.abrupt(\"return\");case 8:this.fetchStudentData();case 9:case\"end\":return _context4.stop();}}},null,this,null,Promise);}},{key:\"fetchStudentData\",value:function fetchStudentData(){var school_id,response,success,statusCode,message,data,students,classes;return _regeneratorRuntime.async(function fetchStudentData$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:school_id=this.props.route.params.school_id;_context5.next=3;return _regeneratorRuntime.awrap(get(\"/school/\"+school_id+\"/student\"));case 3:response=_context5.sent;success=response.success,statusCode=response.statusCode,message=response.message,data=response.data;if(success){_context5.next=8;break;}alert('Sorry 取得學生資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n'+message);return _context5.abrupt(\"return\");case 8:students=data.students,classes=data.classes;this.props.fetchStudentsSuccess(students,classes);case 10:case\"end\":return _context5.stop();}}},null,this,null,Promise);}},{key:\"render\",value:function render(){var _this4=this;var students=this.props.students;var _this$state2=this.state,showModal=_this$state2.showModal,modal_padding=_this$state2.modal_padding;return React.createElement(View,null,React.createElement(Modal,{modal_padding:modal_padding,show:showModal,component:this.getModalContent(),hideModal:function hideModal(){return _this4.hideModal();}}),React.createElement(ScrollView,null,Object.keys(students).map(function(id,index){var student=students[id];return React.createElement(View,{key:id,style:{flex:1,backgroundColor:'lightgrey',flexDirection:'row',marginBottom:10,padding:15}},React.createElement(TouchableHighlight,{style:{},onPress:function onPress(){return _this4._pickImage(id,student.profile_picture);}},React.createElement(Image,{source:student.profile_picture===''?require(\"../../../assets/icon-thumbnail.png\"):{uri:student.profile_picture},style:{width:200,height:200,borderRadius:100}})),React.createElement(View,{style:{flex:5,paddingLeft:15}},React.createElement(View,null,React.createElement(Text,{style:{fontSize:50}},student.name)),React.createElement(View,null,React.createElement(Text,{style:{fontSize:20}},\"\\u5730\\u5740: \",student.address)),React.createElement(View,null,React.createElement(Text,{style:{fontSize:20}},\"\\u624B\\u6A5F(\\u7236): \",student.father_phone)),React.createElement(View,null,React.createElement(Text,{style:{fontSize:20}},\"\\u624B\\u6A5F(\\u6BCD): \",student.mother_phone))),React.createElement(View,{style:{flex:1,justifyContent:'space-evenly'}},React.createElement(View,{style:{backgroundColor:'white'}},React.createElement(TouchableHighlight,{style:{padding:15,justifyContent:'center'},onPress:function onPress(event){return _this4.setState({showModal:true,modal_type:'student',student_id:id,modal_padding:Math.max(0,event.nativeEvent.pageY-height)});}},React.createElement(Text,{style:{fontSize:25,alignSelf:'center'}},\"\\u7DE8\\u8F2F\"))),React.createElement(View,{style:{backgroundColor:'#fa625f'}},React.createElement(TouchableHighlight,{style:{padding:15,justifyContent:'center'},onPress:function onPress(){return _this4.confirmDeleteStudent(id);}},React.createElement(Text,{style:{fontSize:25,alignSelf:'center'}},\"\\u522A\\u9664\")))));})));}}]);return Students;}(React.Component);var mapStateToProps=function mapStateToProps(state){return{students:state.school.students,classes:state.school.classes};};var mapDispatchToProps=function mapDispatchToProps(dispatch){return _objectSpread({},bindActionCreators({updateProfilePicture:updateProfilePicture,fetchStudentsSuccess:fetchStudentsSuccess,editStudentSuccess:editStudentSuccess},dispatch));};export default connect(mapStateToProps,mapDispatchToProps)(Students);","map":{"version":3,"sources":["/home/caleb_lee/gina_web_app/components/teacher/admin/students.js"],"names":["React","connect","ImagePicker","Permissions","bindActionCreators","updateProfilePicture","fetchStudentsSuccess","editStudentSuccess","get","post","delete_by_id","Modal","EditStudentProfile","AddParent","QRPage","Dimensions","width","height","Students","props","getPermissionAsync","Platform","OS","askAsync","CAMERA_ROLL","status","alert","_pickImage","student_id","url","launchImageLibraryAsync","mediaTypes","MediaTypeOptions","All","allowsEditing","aspect","quality","base64","result","cancelled","getProfilePictureURL","console","log","state","showModal","modal_type","parent_data","qr_data","modal_padding","image","school_name","route","params","students","body","path","Date","getMilliseconds","response","success","statusCode","message","data","name","image_url","classes","setState","old_class_id","class_id","hideModal","Alert","text","style","onPress","deleteStudentById","fetchStudentData","school_id","getModalContent","Object","keys","map","id","index","student","flex","backgroundColor","flexDirection","marginBottom","padding","profile_picture","require","uri","borderRadius","paddingLeft","fontSize","address","father_phone","mother_phone","justifyContent","event","Math","max","nativeEvent","pageY","alignSelf","confirmDeleteStudent","Component","mapStateToProps","school","mapDispatchToProps","dispatch"],"mappings":"s4DAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,C,weAEA,OAASC,OAAT,KAAwB,aAAxB,CACA,MAAO,GAAKC,CAAAA,WAAZ,KAA6B,mBAA7B,CACA,MAAO,GAAKC,CAAAA,WAAZ,KAA6B,kBAA7B,CACA,OAASC,kBAAT,KAAmC,OAAnC,CACA,OAASC,oBAAT,CAA+BC,oBAA/B,CAAqDC,kBAArD,2CACA,OAASC,GAAT,CAAcC,IAAd,CAAoBC,YAApB,kBACA,MAAOC,CAAAA,KAAP,eACA,MAAOC,CAAAA,kBAAP,4BACA,MAAOC,CAAAA,SAAP,mBACA,MAAOC,CAAAA,MAAP,gB,oBAE0BC,UAAU,CAACP,GAAX,CAAe,QAAf,C,CAAlBQ,K,iBAAAA,K,CAAOC,M,iBAAAA,M,IAYTC,CAAAA,Q,mGACJ,kBAAYC,KAAZ,CAAmB,0CACjB,uBAAMA,KAAN,EADiB,MAgBnBC,kBAhBmB,CAgBE,0KACfC,QAAQ,CAACC,EAAT,GAAgB,KADD,2EAEQnB,WAAW,CAACoB,QAAZ,CAAqBpB,WAAW,CAACqB,WAAjC,CAFR,6CAETC,MAFS,uBAETA,MAFS,CAGjB,GAAIA,MAAM,GAAK,SAAf,CAA0B,CACxBC,KAAK,CAAC,2DAAD,CAAL,CACD,CALgB,qEAhBF,OAyBnBC,UAzBmB,CAyBN,kBAAOC,UAAP,CAAmBC,GAAnB,4MAEU3B,WAAW,CAAC4B,uBAAZ,CAAoC,CACrDC,UAAU,CAAE7B,WAAW,CAAC8B,gBAAZ,CAA6BC,GADY,CAErDC,aAAa,CAAE,IAFsC,CAGrDC,MAAM,CAAE,CAAC,CAAD,CAAG,CAAH,CAH6C,CAIrDC,OAAO,CAAE,GAJ4C,CAKrDC,MAAM,CAAE,IAL6C,CAApC,CAFV,SAELC,MAFK,gBAST,GAAI,CAACA,MAAM,CAACC,SAAZ,CAAuB,CACbF,MADa,CACFC,MADE,CACbD,MADa,CAGrB,MAAKG,oBAAL,CAA0BH,MAA1B,CAAkCT,UAAlC,CAA8CC,GAA9C,EACD,CAbQ,mFAiBTY,OAAO,CAACC,GAAR,eAjBS,0EAzBM,CAEjB,MAAKC,KAAL,CAAW,CACTC,SAAS,CAAE,KADF,CAETC,UAAU,CAAE,EAFH,CAGTjB,UAAU,CAAE,EAHH,CAITkB,WAAW,CAAE,EAJJ,CAKTC,OAAO,CAAE,EALA,CAMTC,aAAa,CAAE,CANN,CAAX,CAFiB,aAUlB,C,kFAEmB,CAClB,KAAK5B,kBAAL,GACD,C,kEAgC0B6B,K,CAAOrB,U,CAAYC,G,0MACpCqB,W,CAAgB,KAAK/B,KAAL,CAAWgC,KAAX,CAAiBC,M,CAAjCF,W,CACAG,Q,CAAa,KAAKlC,K,CAAlBkC,Q,CACFC,I,CAAO,CACXL,KAAK,CAALA,KADW,CAEXpB,GAAG,CAAHA,GAFW,CAGX0B,IAAI,CAAKL,WAAL,qBAAoCtB,UAApC,KAAmD,GAAI4B,CAAAA,IAAJ,EAAD,CAAaC,eAAb,EAAlD,OAHO,C,mDAKUhD,IAAI,aAAamB,UAAb,oBAA2C0B,IAA3C,C,SAArBI,Q,gBAEEC,O,CAAuCD,Q,CAAvCC,O,CAASC,U,CAA8BF,Q,CAA9BE,U,CAAYC,O,CAAkBH,Q,CAAlBG,O,CAASC,I,CAASJ,Q,CAATI,I,IACjCH,O,2BACHjC,KAAK,CAAC,SAAS2B,QAAQ,CAACzB,UAAD,CAAR,CAAqBmC,IAA9B,4IAAiEF,OAAlE,CAAL,C,0CAGF,KAAK1C,KAAL,CAAWd,oBAAX,CAAgCuB,UAAhC,CAA4CkC,IAAI,CAACE,SAAjD,E,gIAGgB,iCACc,KAAK7C,KADnB,CACRkC,QADQ,aACRA,QADQ,CACEY,OADF,aACEA,OADF,iBAEoD,KAAKtB,KAFzD,CAERC,SAFQ,aAERA,SAFQ,CAEGC,UAFH,aAEGA,UAFH,CAEejB,UAFf,aAEeA,UAFf,CAE2BkB,WAF3B,aAE2BA,WAF3B,CAEwCC,OAFxC,aAEwCA,OAFxC,CAIhB,GAAI,CAACH,SAAL,CAAgB,CACd,MAAO,KAAP,CACD,CAFD,IAEO,IAAIC,UAAU,GAAK,SAAnB,CAA8B,CACnC,MAAO,qBAAC,kBAAD,EACC,UAAU,CAAEjB,UADb,CAEC,OAAO,CAAEyB,QAAQ,CAACzB,UAAD,CAFlB,CAGC,OAAO,CAAEqC,OAHV,CAIC,SAAS,CAAE,mBAACnB,WAAD,QAAiB,CAAA,MAAI,CAACoB,QAAL,CAAc,CACxCrB,UAAU,CAAE,YAD4B,CAExCC,WAAW,CAAXA,WAFwC,CAAd,CAAjB,EAJZ,CAQC,kBAAkB,CAAE,4BAAClB,UAAD,CAAamC,IAAb,CAAmBI,YAAnB,CAAiCC,QAAjC,QAClB,CAAA,MAAI,CAACjD,KAAL,CAAWZ,kBAAX,CAA8BqB,UAA9B,CAA0CmC,IAA1C,CAAgDI,YAAhD,CAA8DC,QAA9D,CADkB,EARrB,CAWC,SAAS,CAAE,2BAAM,CAAA,MAAI,CAACC,SAAL,EAAN,EAXZ,EAAP,CAaD,CAdM,IAcA,IAAIxB,UAAU,GAAK,YAAnB,CAAiC,CACtC,MAAO,qBAAC,SAAD,EACC,UAAU,CAAEjB,UADb,CAEC,WAAW,CAAEkB,WAFd,CAGC,UAAU,CAAE,oBAACC,OAAD,QAAa,CAAA,MAAI,CAACmB,QAAL,CAAc,CACrCrB,UAAU,CAAE,QADyB,CAErCE,OAAO,CAAPA,OAFqC,CAAd,CAAb,EAHb,CAOC,MAAM,CAAE,wBAAM,CAAA,MAAI,CAACmB,QAAL,CAAc,CAC1BrB,UAAU,CAAE,SADc,CAAd,CAAN,EAPT,EAAP,CAWD,CAZM,IAYA,CACL,MAAO,qBAAC,MAAD,EACC,OAAO,CAAEE,OADV,CAEC,YAAY,CAAEM,QAAQ,CAACzB,UAAD,CAAR,CAAqBmC,IAFpC,CAGC,WAAW,CAAEjB,WAHd,CAIC,MAAM,CAAE,wBAAM,CAAA,MAAI,CAACoB,QAAL,CAAc,CAC1BrB,UAAU,CAAE,YADc,CAAd,CAAN,EAJT,EAAP,CAQD,CACF,C,6CAEW,CACV,KAAKqB,QAAL,CAAc,CACZtB,SAAS,CAAE,KADC,CAAd,EAGD,C,kEAEoBhB,U,CAAY,oBACxByB,CAAAA,QADwB,CACZ,KAAKlC,KADO,CACxBkC,QADwB,CAE/BiB,KAAK,CAAC5C,KAAN,CACK2B,QAAQ,CAACzB,UAAD,CAAR,CAAqBmC,IAD1B,6BAEE,wBAFF,CAGE,CACE,CAAEQ,IAAI,CAAE,IAAR,CAAcC,KAAK,CAAE,QAArB,CADF,CAEE,CAAED,IAAI,CAAE,IAAR,CAAcE,OAAO,CAAE,yBAAM,CAAA,MAAI,CAACC,iBAAL,CAAuB9C,UAAvB,CAAN,EAAvB,CAFF,CAHF,EAQD,C,4DAEuBA,U,sLACdyB,Q,CAAa,KAAKlC,K,CAAlBkC,Q,mDACe3C,YAAY,aAAakB,UAAb,K,SAA7B8B,Q,gBACEC,O,CAAuCD,Q,CAAvCC,O,CAASC,U,CAA8BF,Q,CAA9BE,U,CAAYC,O,CAAkBH,Q,CAAlBG,O,CAASC,I,CAASJ,Q,CAATI,I,IACjCH,O,0BACHjC,KAAK,CAAC,SAAS2B,QAAQ,CAACzB,UAAD,CAAR,CAAqBmC,IAA9B,4IAAiEF,OAAlE,CAAL,C,yCAGF,KAAKc,gBAAL,G,uUAIQC,S,CAAc,KAAKzD,KAAL,CAAWgC,KAAX,CAAiBC,M,CAA/BwB,S,mDACepE,GAAG,YAAYoE,SAAZ,Y,SAApBlB,Q,gBACEC,O,CAAuCD,Q,CAAvCC,O,CAASC,U,CAA8BF,Q,CAA9BE,U,CAAYC,O,CAAkBH,Q,CAAlBG,O,CAASC,I,CAASJ,Q,CAATI,I,IACjCH,O,0BACDjC,KAAK,CAAC,qCAAuCmC,OAAxC,CAAL,C,yCAIGR,Q,CAAqBS,I,CAArBT,Q,CAAUY,O,CAAWH,I,CAAXG,O,CACjB,KAAK9C,KAAL,CAAWb,oBAAX,CAAgC+C,QAAhC,CAA0CY,OAA1C,E,8GAGO,oBACCZ,CAAAA,QADD,CACc,KAAKlC,KADnB,CACCkC,QADD,kBAE8B,KAAKV,KAFnC,CAECC,SAFD,cAECA,SAFD,CAEYI,aAFZ,cAEYA,aAFZ,CAIP,MACE,qBAAC,IAAD,MACE,oBAAC,KAAD,EACE,aAAa,CAAEA,aADjB,CAEE,IAAI,CAAEJ,SAFR,CAGE,SAAS,CAAE,KAAKiC,eAAL,EAHb,CAIE,SAAS,CAAE,2BAAM,CAAA,MAAI,CAACR,SAAL,EAAN,EAJb,EADF,CAOE,oBAAC,UAAD,MACGS,MAAM,CAACC,IAAP,CAAY1B,QAAZ,EAAsB2B,GAAtB,CAA0B,SAACC,EAAD,CAAKC,KAAL,CAAe,CACxC,GAAMC,CAAAA,OAAO,CAAG9B,QAAQ,CAAC4B,EAAD,CAAxB,CACA,MACE,qBAAC,IAAD,EAAM,GAAG,CAAEA,EAAX,CAAe,KAAK,CAAE,CAAEG,IAAI,CAAC,CAAP,CAAUC,eAAe,CAAE,WAA3B,CAAwCC,aAAa,CAAE,KAAvD,CAA8DC,YAAY,CAAE,EAA5E,CAAgFC,OAAO,CAAE,EAAzF,CAAtB,EAEE,oBAAC,kBAAD,EACE,KAAK,CAAE,EADT,CAEE,OAAO,CAAE,yBAAM,CAAA,MAAI,CAAC7D,UAAL,CAAgBsD,EAAhB,CAAoBE,OAAO,CAACM,eAA5B,CAAN,EAFX,EAIE,oBAAC,KAAD,EACE,MAAM,CACFN,OAAO,CAACM,eAAR,GAA4B,EAA5B,CACIC,OAAO,sCADX,CAEM,CAACC,GAAG,CAAER,OAAO,CAACM,eAAd,CAJZ,CAME,KAAK,CAAE,CACLzE,KAAK,CAAE,GADF,CAELC,MAAM,CAAE,GAFH,CAGL2E,YAAY,CAAE,GAHT,CANT,EAJF,CAFF,CAoBE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAER,IAAI,CAAE,CAAR,CAAWS,WAAW,CAAE,EAAxB,CAAb,EAEE,oBAAC,IAAD,MACE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAEC,QAAQ,CAAE,EAAZ,CAAb,EAAgCX,OAAO,CAACpB,IAAxC,CADF,CAFF,CAOE,oBAAC,IAAD,MACE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAE+B,QAAQ,CAAE,EAAZ,CAAb,mBAAoCX,OAAO,CAACY,OAA5C,CADF,CAPF,CAYE,oBAAC,IAAD,MACE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAED,QAAQ,CAAE,EAAZ,CAAb,2BAAuCX,OAAO,CAACa,YAA/C,CADF,CAZF,CAiBE,oBAAC,IAAD,MACE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAEF,QAAQ,CAAE,EAAZ,CAAb,2BAAuCX,OAAO,CAACc,YAA/C,CADF,CAjBF,CApBF,CA2CE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAEb,IAAI,CAAE,CAAR,CAAWc,cAAc,CAAE,cAA3B,CAAb,EACE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAEb,eAAe,CAAE,OAAnB,CAAb,EACE,oBAAC,kBAAD,EACE,KAAK,CAAE,CAACG,OAAO,CAAE,EAAV,CAAcU,cAAc,CAAE,QAA9B,CADT,CAEE,OAAO,CAAE,iBAACC,KAAD,QAAW,CAAA,MAAI,CAACjC,QAAL,CAAc,CAChCtB,SAAS,CAAE,IADqB,CAEhCC,UAAU,CAAE,SAFoB,CAGhCjB,UAAU,CAAEqD,EAHoB,CAIhCjC,aAAa,CAAEoD,IAAI,CAACC,GAAL,CAAS,CAAT,CAAYF,KAAK,CAACG,WAAN,CAAkBC,KAAlB,CAA0BtF,MAAtC,CAJiB,CAAd,CAAX,EAFX,EASE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAE6E,QAAQ,CAAE,EAAZ,CAAgBU,SAAS,CAAE,QAA3B,CAAb,iBATF,CADF,CADF,CAeE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAEnB,eAAe,CAAE,SAAnB,CAAb,EACE,oBAAC,kBAAD,EACE,KAAK,CAAE,CAACG,OAAO,CAAE,EAAV,CAAcU,cAAc,CAAE,QAA9B,CADT,CAEE,OAAO,CAAE,yBAAM,CAAA,MAAI,CAACO,oBAAL,CAA0BxB,EAA1B,CAAN,EAFX,EAIE,oBAAC,IAAD,EAAM,KAAK,CAAE,CAAEa,QAAQ,CAAE,EAAZ,CAAgBU,SAAS,CAAE,QAA3B,CAAb,iBAJF,CADF,CAfF,CA3CF,CADF,CAuED,CAzEA,CADH,CAPF,CADF,CAsFD,C,sBAjPoBxG,KAAK,CAAC0G,S,EAoP7B,GAAMC,CAAAA,eAAe,CAAG,QAAlBA,CAAAA,eAAkB,CAAChE,KAAD,CAAW,CACjC,MAAO,CACLU,QAAQ,CAAEV,KAAK,CAACiE,MAAN,CAAavD,QADlB,CAELY,OAAO,CAAEtB,KAAK,CAACiE,MAAN,CAAa3C,OAFjB,CAAP,CAID,CALD,CAOA,GAAM4C,CAAAA,kBAAkB,CAAG,QAArBA,CAAAA,kBAAqB,CAACC,QAAD,CAAc,CACvC,wBACK1G,kBAAkB,CAAC,CACpBC,oBAAoB,CAApBA,oBADoB,CAEpBC,oBAAoB,CAApBA,oBAFoB,CAGpBC,kBAAkB,CAAlBA,kBAHoB,CAAD,CAIlBuG,QAJkB,CADvB,EAOD,CARD,CAUA,cAAe7G,CAAAA,OAAO,CAAC0G,eAAD,CAAkBE,kBAAlB,CAAP,CAA8C3F,QAA9C,CAAf","sourcesContent":["import React from 'react'\nimport { View, TouchableHighlight, Image, Text, ScrollView, Platform, Alert, Dimensions } from 'react-native'\nimport { connect } from 'react-redux'\nimport * as ImagePicker from 'expo-image-picker';\nimport * as Permissions from 'expo-permissions';\nimport { bindActionCreators } from 'redux';\nimport { updateProfilePicture, fetchStudentsSuccess, editStudentSuccess } from '../../../redux/school/actions/index'\nimport { get, post, delete_by_id } from '../../util'\nimport Modal from './modal'\nimport EditStudentProfile from './editstudentprofile'\nimport AddParent from './addparent';\nimport QRPage from './qrpage';\n\nconst { width, height } = Dimensions.get('window')\n/* \nPage where we view/edit class information including:\n  -adding/removing class\n  -adding/removing/switching students\n  -adding/removing/switching teachers\n*/\n// const editStudent = \n//     <View>\n//       <Text>Student</Text>\n//     </View>\n\nclass Students extends React.Component{\n  constructor(props) {\n    super(props)\n    this.state={\n      showModal: false,\n      modal_type: '',\n      student_id: '',\n      parent_data: {},\n      qr_data: '',\n      modal_padding: 0\n    }\n  }\n\n  componentDidMount() {\n    this.getPermissionAsync();\n  }\n\n  getPermissionAsync = async () => {\n    if (Platform.OS === 'ios') {\n      const { status } = await Permissions.askAsync(Permissions.CAMERA_ROLL);\n      if (status !== 'granted') {\n        alert('Sorry, we need camera roll permissions to make this work!');\n      }\n    }\n  };\n\n  _pickImage = async (student_id, url) => {\n    try {\n      let result = await ImagePicker.launchImageLibraryAsync({\n        mediaTypes: ImagePicker.MediaTypeOptions.All,\n        allowsEditing: true,\n        aspect: [1,1],\n        quality: 0.4,\n        base64: true\n      });\n      if (!result.cancelled) {\n        const { base64 } = result\n        // this.setState({ image: result.uri });\n        this.getProfilePictureURL(base64, student_id, url)\n      }\n\n      // console.log(result);\n    } catch (E) {\n      console.log(E);\n    }\n  };\n\n  async getProfilePictureURL(image, student_id, url) {\n    const { school_name } = this.props.route.params\n    const { students } = this.props\n    const body = {\n      image,\n      url,\n      path: `${school_name}/profile_picture_${student_id}_${(new Date()).getMilliseconds()}.jpg`\n    }\n    const response = await post(`/student/${student_id}/profile-picture`, body)\n    // console.log(response)\n    const { success, statusCode, message, data } = response\n    if (!success) {\n      alert(`Sorry ${students[student_id].name}照片上傳時電腦出狀況了！請截圖和與工程師聯繫\\n\\n` + message)\n      return \n    }\n    this.props.updateProfilePicture(student_id, data.image_url)\n  }\n\n  getModalContent() {\n    const { students, classes } = this.props\n    const { showModal, modal_type, student_id, parent_data, qr_data } = this.state\n    // console.log('students: ', students)\n    if (!showModal) {\n      return null\n    } else if (modal_type === 'student') {\n      return <EditStudentProfile\n              student_id={student_id}\n              student={students[student_id]}\n              classes={classes}\n              addParent={(parent_data) => this.setState({\n                modal_type: 'add_parent',\n                parent_data\n              })}\n              editStudentSuccess={(student_id, name, old_class_id, class_id) => \n                this.props.editStudentSuccess(student_id, name, old_class_id, class_id)\n              }\n              hideModal={() => this.hideModal()}\n            />\n    } else if (modal_type === 'add_parent') {\n      return <AddParent\n              student_id={student_id}\n              parent_data={parent_data}\n              viewQRCode={(qr_data) => this.setState({\n                modal_type: 'qrpage',\n                qr_data\n              })}\n              goBack={() => this.setState({\n                modal_type: 'student'\n              })}\n            />\n    } else { // modal_type: 'qrpage'\n      return <QRPage\n              qr_data={qr_data}\n              student_name={students[student_id].name}\n              parent_data={parent_data}\n              goBack={() => this.setState({\n                modal_type: 'add_parent'\n              })}\n            />\n    }\n  }\n\n  hideModal() {\n    this.setState({\n      showModal: false\n    })\n  }\n\n  confirmDeleteStudent(student_id) {\n    const {students} = this.props\n    Alert.alert(\n      `${students[student_id].name} 刪除確認`,\n      '刪除這個寶貝會將一切攸關資料(包誇父母)刪除',\n      [\n        { text: \"取消\", style: \"cancel\"},\n        { text: 'OK', onPress: () => this.deleteStudentById(student_id) }\n      ]\n    )\n  }\n\n  async deleteStudentById(student_id) {\n    const { students } = this.props\n    const response = await delete_by_id(`/student/${student_id}/`)\n    const { success, statusCode, message, data } = response\n    if (!success) {\n      alert(`Sorry ${students[student_id].name}照片上傳時電腦出狀況了！請截圖和與工程師聯繫\\n\\n` + message)\n      return \n    }\n    this.fetchStudentData()\n  }\n\n  async fetchStudentData() {\n    const { school_id } = this.props.route.params\n    const response = await get(`/school/${school_id}/student`)\n    const { success, statusCode, message, data } = response\n    if (!success) {\n        alert('Sorry 取得學生資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n' + message)\n        return \n    }\n\n    const {students, classes} = data\n    this.props.fetchStudentsSuccess(students, classes)\n  }\n\n  render() {\n    const { students } = this.props\n    const { showModal, modal_padding } = this.state\n    // console.log('students: ', students)\n    return (\n      <View>\n        <Modal\n          modal_padding={modal_padding}\n          show={showModal}\n          component={this.getModalContent()}\n          hideModal={() => this.hideModal()}\n        />\n        <ScrollView>\n          {Object.keys(students).map((id, index) => {\n            const student = students[id]\n            return (\n              <View key={id} style={{ flex:1, backgroundColor: 'lightgrey', flexDirection: 'row', marginBottom: 10, padding: 15 }}>\n                {/* profile picture */}\n                <TouchableHighlight\n                  style={{ }}\n                  onPress={() => this._pickImage(id, student.profile_picture)}\n                >\n                  <Image\n                    source={\n                        student.profile_picture === '' ?\n                            require('../../../assets/icon-thumbnail.png')\n                            : {uri: student.profile_picture}\n                    }\n                    style={{\n                      width: 200,\n                      height: 200,\n                      borderRadius: 100\n                    }}\n                  />\n                </TouchableHighlight>\n                \n                <View style={{ flex: 5, paddingLeft: 15 }}>\n                  {/* Name */}\n                  <View>\n                    <Text style={{ fontSize: 50 }}>{student.name}</Text>\n                  </View>\n\n                  {/* Address */}\n                  <View>\n                    <Text style={{ fontSize: 20 }}>地址: {student.address}</Text>\n                  </View>\n\n                  {/* Father phone */}\n                  <View>\n                    <Text style={{ fontSize: 20 }}>手機(父): {student.father_phone}</Text>\n                  </View>\n\n                  {/* Mother phone */}\n                  <View>\n                    <Text style={{ fontSize: 20 }}>手機(母): {student.mother_phone}</Text>\n                  </View>\n                </View>\n\n                {/* Right */}\n                <View style={{ flex: 1, justifyContent: 'space-evenly' }}>\n                  <View style={{ backgroundColor: 'white' }}>\n                    <TouchableHighlight\n                      style={{padding: 15, justifyContent: 'center'}}\n                      onPress={(event) => this.setState({ \n                        showModal: true, \n                        modal_type: 'student', \n                        student_id: id,\n                        modal_padding: Math.max(0, event.nativeEvent.pageY - height)\n                      })}\n                    >\n                      <Text style={{ fontSize: 25, alignSelf: 'center' }}>編輯</Text>\n                    </TouchableHighlight>\n                  </View>\n\n                  <View style={{ backgroundColor: '#fa625f' }}>\n                    <TouchableHighlight\n                      style={{padding: 15, justifyContent: 'center'}}\n                      onPress={() => this.confirmDeleteStudent(id)}\n                    >\n                      <Text style={{ fontSize: 25, alignSelf: 'center' }}>刪除</Text>\n                    </TouchableHighlight>\n                  </View>\n\n                </View>\n              </View>\n            )\n          })}\n        </ScrollView>\n      </View>\n    )\n  }\n}\n\nconst mapStateToProps = (state) => {\n  return {\n    students: state.school.students,\n    classes: state.school.classes\n  }\n}\n\nconst mapDispatchToProps = (dispatch) => {\n  return {\n    ...bindActionCreators({\n      updateProfilePicture,\n      fetchStudentsSuccess,\n      editStudentSuccess,\n    }, dispatch)\n  }\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps) (Students)"]},"metadata":{},"sourceType":"module"}