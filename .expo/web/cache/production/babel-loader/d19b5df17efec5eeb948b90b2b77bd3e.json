{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";import _assertThisInitialized from\"@babel/runtime/helpers/assertThisInitialized\";import _inherits from\"@babel/runtime/helpers/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import React from'react';import View from\"react-native-web/dist/exports/View\";import Text from\"react-native-web/dist/exports/Text\";import TouchableHighlight from\"react-native-web/dist/exports/TouchableHighlight\";import Alert from\"react-native-web/dist/exports/Alert\";import{Toast}from'native-base';import Auth from'@aws-amplify/auth';import{connect}from'react-redux';import{bindActionCreators}from'redux';import{setConnectState,fetchClassesSuccess,fetchTeachersSuccess,fetchStudentsSuccess,initializeStudentWellness,clearSchoolState,addPickupRequest,updateViewingStatus,fetchStudentAttendanceSuccess}from\"../../redux/school/actions/index\";import{get,formatDate}from\"../util\";import NetInfo from'@react-native-community/netinfo';import LoginNumberPad from\"./loginnumberpad\";import ENV from\"../../variables\";var SchoolHome=function(_React$Component){_inherits(SchoolHome,_React$Component);var _super=_createSuper(SchoolHome);function SchoolHome(props){var _this;_classCallCheck(this,SchoolHome);_this=_super.call(this,props);_this.state={classes:[],err_message:'',showLoginNumberPad:false,pageClicked:'',class_id:'',admin_id:''};_this.handleSignOut=_this.handleSignOut.bind(_assertThisInitialized(_this));return _this;}_createClass(SchoolHome,[{key:\"componentDidMount\",value:function componentDidMount(){var _this2=this;var school_id;return _regeneratorRuntime.async(function componentDidMount$(_context){while(1){switch(_context.prev=_context.next){case 0:window.addEventListener('offline',function(e){_this2.props.setConnectState(false);});window.addEventListener('online',function(){_this2.props.setConnectState(true);});school_id=this.props.route.params.school_id;_context.next=5;return _regeneratorRuntime.awrap(this.fetchClassIdAndName());case 5:this.fetchTeacherData(school_id);this.fetchStudentData(school_id);case 7:case\"end\":return _context.stop();}}},null,this,null,Promise);}},{key:\"fetchClassIdAndName\",value:function fetchClassIdAndName(){var _this3=this;var school_id;return _regeneratorRuntime.async(function fetchClassIdAndName$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:school_id=this.props.route.params.school_id;_context2.next=3;return _regeneratorRuntime.awrap(fetch(\"https://iejnoswtqj.execute-api.us-east-1.amazonaws.com/\"+ENV+\"/school/\"+school_id,{method:'GET',headers:{Accept:'application/json','Content-Type':'application/json'}}).then(function(res){return res.json();}).then(function(resJson){var statusCode=resJson.statusCode,message=resJson.message,data=resJson.data;if(statusCode>200||message==='Internal server error'){alert('Sorry 取得教室資料時電腦出狀況了！請截圖和與工程師聯繫 '+message);return;}_this3.setState({classes:data.classes});var classes={};data.classes.forEach(function(class_data){var id=class_data.id,name=class_data.name;classes[id]={teachers:[],students:[],name:name};});_this3.props.fetchClassesSuccess(classes,data.admin_passcode);}).catch(function(err){alert('Sorry 取得教室資料時電腦出狀況了！請截圖和與工程師聯繫');}));case 3:case\"end\":return _context2.stop();}}},null,this,null,Promise);}},{key:\"fetchTeacherData\",value:function fetchTeacherData(school_id){var response,success,statusCode,message,data,admins,teachers,classes;return _regeneratorRuntime.async(function fetchTeacherData$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _regeneratorRuntime.awrap(get(\"/school/\"+school_id+\"/teacher\"));case 2:response=_context3.sent;success=response.success,statusCode=response.statusCode,message=response.message,data=response.data;if(success){_context3.next=7;break;}alert('Sorry 取得教師資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n'+message);return _context3.abrupt(\"return\");case 7:admins=data.admins,teachers=data.teachers,classes=data.classes;this.props.fetchTeachersSuccess(admins,teachers,classes);this.getAdminId(teachers);case 10:case\"end\":return _context3.stop();}}},null,this,null,Promise);}},{key:\"getAdminId\",value:function getAdminId(teachers){var teacher_id_array=Object.keys(teachers);for(var i=0;i<teacher_id_array.length;i++){if(teachers[teacher_id_array[i]].name==='管理員'){this.setState({admin_id:teacher_id_array[i]});return;}}}},{key:\"fetchStudentData\",value:function fetchStudentData(school_id){var response,success,statusCode,message,data,students,classes;return _regeneratorRuntime.async(function fetchStudentData$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _regeneratorRuntime.awrap(get(\"/school/\"+school_id+\"/student\"));case 2:response=_context4.sent;success=response.success,statusCode=response.statusCode,message=response.message,data=response.data;if(success){_context4.next=7;break;}alert('Sorry 取得學生資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n'+message);return _context4.abrupt(\"return\");case 7:students=data.students,classes=data.classes;this.props.fetchStudentsSuccess(students,classes);this.props.initializeStudentWellness(Object.keys(students));case 10:case\"end\":return _context4.stop();}}},null,this,null,Promise);}},{key:\"fetchPickupRequest\",value:function fetchPickupRequest(school_id){var _this4=this;var query=\"https://iejnoswtqj.execute-api.us-east-1.amazonaws.com/dev/attendance/pickup-request?school_id=\"+school_id;fetch(query,{method:'GET',headers:{Accept:'application/json','Content-Type':'application/json'}}).then(function(res){return res.json();}).then(function(resJson){if(resJson.data.length>0){_this4.props.addPickupRequest(resJson.data);_this4.props.navigation.navigate('PickupAlert',{});}}).catch(function(err){alert('Sorry 取得接回告知時電腦出狀況了！請截圖和與工程師聯繫');});}},{key:\"fetchStudentAttendance\",value:function fetchStudentAttendance(){var school_id,date,response,success,statusCode,message,data,attendance,students,present,absent;return _regeneratorRuntime.async(function fetchStudentAttendance$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:school_id=this.props.route.params.school_id;date=formatDate(new Date());_context5.next=4;return _regeneratorRuntime.awrap(get(\"/attendance?school_id=\"+school_id+\"&date=\"+date));case 4:response=_context5.sent;success=response.success,statusCode=response.statusCode,message=response.message,data=response.data;if(success){_context5.next=9;break;}alert('Sorry 取得學生出席資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n'+message);return _context5.abrupt(\"return\");case 9:attendance=data.attendance,students=data.students,present=data.present,absent=data.absent;this.props.fetchStudentAttendanceSuccess(attendance,students,present,absent);case 11:case\"end\":return _context5.stop();}}},null,this,null,Promise);}},{key:\"handleEnterPasscode\",value:function handleEnterPasscode(passcode){console.log(passcode);var _this$props$route$par=this.props.route.params,school_name=_this$props$route$par.school_name,school_id=_this$props$route$par.school_id;var _this$props=this.props,passcodeAdminId=_this$props.passcodeAdminId,passcodeTeacherId=_this$props.passcodeTeacherId,classes=_this$props.classes,teachers=_this$props.teachers;var _this$state=this.state,pageClicked=_this$state.pageClicked,class_id=_this$state.class_id;var teacher_id=passcodeTeacherId[passcode];var admin_id=passcodeAdminId[passcode];console.log(admin_id);if(teacher_id===undefined&&admin_id===undefined){alert('密碼不正確！請截圖和與工程師聯繫');}else if(admin_id!==undefined){this.setState({showLoginNumberPad:false});this.props.navigation.navigate(pageClicked,{school_name:school_name,school_id:school_id,class_id:class_id,class_name:'管理員：'+teachers[admin_id].name,isAdmin:true,admin_id:admin_id});}else if(class_id!==''&&!classes[class_id].teachers.includes(teacher_id)||pageClicked==='AdminHome'){alert('Sorry 權限不合！請截圖和與工程師聯繫');}else{this.setState({showLoginNumberPad:false});this.props.updateViewingStatus('teacher');this.props.navigation.navigate('TeacherHome',{class_id:class_id,class_name:classes[class_id].name,isAdmin:false});}}},{key:\"hideLoginPad\",value:function hideLoginPad(){this.setState({showLoginNumberPad:false});}},{key:\"handleSignOut\",value:function handleSignOut(){var loadAuth=this.props.route.params.loadAuth;Auth.signOut().then(function(){loadAuth();}).catch(function(err){return console.log(err);});}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){var _this5=this;window.removeEventListener('offline',function(e){_this5.props.setConnectState(false);});window.removeEventListener('online',function(e){_this5.props.setConnectState(false);});this.props.clearSchoolState();}},{key:\"render\",value:function render(){var _this6=this;var _this$state2=this.state,classes=_this$state2.classes,showLoginNumberPad=_this$state2.showLoginNumberPad;var school_id=this.props.route.params.school_id;return React.createElement(View,{style:{flex:1,flexDirection:'column'}},showLoginNumberPad?React.createElement(LoginNumberPad,{handleEnterPasscode:function handleEnterPasscode(passcode){return _this6.handleEnterPasscode(passcode);},hideLoginPad:function hideLoginPad(){return _this6.hideLoginPad();}}):null,React.createElement(View,{style:{flex:1,flexDirection:'row'}},React.createElement(TouchableHighlight,{key:\"admin\",style:{flex:1,backgroundColor:'#74b987',margin:10,justifyContent:'center'},onPress:function onPress(){return _this6.setState({showLoginNumberPad:true,pageClicked:'AdminHome'});}},React.createElement(Text,{style:{fontSize:50,textAlign:'center'}},\"\\u884C\\u653F\\u7BA1\\u7406\"))),React.createElement(TouchableHighlight,{key:\"attendance_page\",style:{flex:1,backgroundColor:'#74b987',margin:10,justifyContent:'center'},onPress:function onPress(){_this6.props.navigation.push('AttendancePage',{school_id:school_id});}},React.createElement(Text,{style:{fontSize:80,textAlign:'center'}},\"\\u51FA\\u5E2D/\\u6253\\u5361\")),React.createElement(View,{style:{flex:3}},classes.map(function(class_data){if(class_data.name==='管理員')return null;return React.createElement(TouchableHighlight,{key:class_data.id,style:{flex:1,backgroundColor:'#74b987',margin:10,justifyContent:'center'},onPress:function onPress(){return _this6.setState({showLoginNumberPad:true,pageClicked:'TeacherHome',class_id:class_data.id});}},React.createElement(Text,{style:{fontSize:80,textAlign:'center'}},class_data.name));})));}}]);return SchoolHome;}(React.Component);var mapStateToProps=function mapStateToProps(state){return{pick_up_request:state.school.pick_up_request,passcodeAdminId:state.school.passcodeAdminId,passcodeTeacherId:state.school.passcodeTeacherId,classes:state.school.classes,teachers:state.school.teachers,viewing_status:state.school.viewing_status,isConnected:state.school.isConnected};};var mapDispatchToProps=function mapDispatchToProps(dispatch){return _objectSpread({},bindActionCreators({setConnectState:setConnectState,fetchClassesSuccess:fetchClassesSuccess,fetchTeachersSuccess:fetchTeachersSuccess,fetchStudentsSuccess:fetchStudentsSuccess,initializeStudentWellness:initializeStudentWellness,addPickupRequest:addPickupRequest,clearSchoolState:clearSchoolState,updateViewingStatus:updateViewingStatus,fetchStudentAttendanceSuccess:fetchStudentAttendanceSuccess},dispatch));};export default connect(mapStateToProps,mapDispatchToProps)(SchoolHome);","map":{"version":3,"sources":["/home/caleb_lee/gina_web_app/components/teacher/schoolhome.js"],"names":["React","Toast","Auth","connect","bindActionCreators","setConnectState","fetchClassesSuccess","fetchTeachersSuccess","fetchStudentsSuccess","initializeStudentWellness","clearSchoolState","addPickupRequest","updateViewingStatus","fetchStudentAttendanceSuccess","get","formatDate","NetInfo","LoginNumberPad","ENV","SchoolHome","props","state","classes","err_message","showLoginNumberPad","pageClicked","class_id","admin_id","handleSignOut","bind","window","addEventListener","e","school_id","route","params","fetchClassIdAndName","fetchTeacherData","fetchStudentData","fetch","method","headers","Accept","then","res","json","resJson","statusCode","message","data","alert","setState","forEach","class_data","id","name","teachers","students","admin_passcode","catch","err","response","success","admins","getAdminId","teacher_id_array","Object","keys","i","length","query","navigation","navigate","date","Date","attendance","present","absent","passcode","console","log","school_name","passcodeAdminId","passcodeTeacherId","teacher_id","undefined","class_name","isAdmin","includes","loadAuth","signOut","removeEventListener","flex","flexDirection","handleEnterPasscode","hideLoginPad","backgroundColor","margin","justifyContent","fontSize","textAlign","push","map","Component","mapStateToProps","pick_up_request","school","viewing_status","isConnected","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["import React from 'react'\nimport { View, Text, TouchableHighlight, Alert } from 'react-native'\nimport { Toast } from 'native-base'\nimport Auth from '@aws-amplify/auth'\nimport { connect } from 'react-redux'\nimport { bindActionCreators } from 'redux'\nimport { \n    setConnectState, \n    fetchClassesSuccess, \n    fetchTeachersSuccess, \n    fetchStudentsSuccess,\n    initializeStudentWellness,\n    clearSchoolState,\n    addPickupRequest,\n    updateViewingStatus,\n    fetchStudentAttendanceSuccess } from '../../redux/school/actions/index'\nimport { get, formatDate } from '../util'\nimport NetInfo from '@react-native-community/netinfo'\nimport LoginNumberPad from './loginnumberpad'\n// import PickupAlert from './pickupalert'\nimport ENV from '../../variables'\n\nclass SchoolHome extends React.Component {\n    constructor(props) {\n        super(props)\n        this.state = {\n            classes: [],\n            err_message: '',\n            showLoginNumberPad: false,\n            pageClicked: '',\n            class_id: '',\n            admin_id: ''\n        }\n        this.handleSignOut = this.handleSignOut.bind(this)\n    }\n\n    async componentDidMount() {\n        // this.unsubscribe = NetInfo.addEventListener(state => {\n        //     const {isConnected} = state\n        //     this.props.setConnectState(isConnected)\n        // });\n        window.addEventListener('offline', (e) => {\n            this.props.setConnectState(false) \n        });\n        window.addEventListener('online', () => {\n            this.props.setConnectState(true)\n        });\n        const { school_id } = this.props.route.params\n        await this.fetchClassIdAndName()\n        this.fetchTeacherData(school_id)\n        this.fetchStudentData(school_id)\n        // this.timeoutId = this.timer(school_id)\n    }\n\n    // timer = (school_id) => setTimeout(() => {\n    //     this.poll(school_id)\n    // }, 10000)\n\n    // async poll(school_id) {\n    //     const { viewing_status } = this.props\n    //     if (viewing_status === '') {\n    //         const query = `https://iejnoswtqj.execute-api.us-east-1.amazonaws.com/dev/class/${school_id}/updates`\n    //         await fetch(query, {\n    //             method: 'GET',\n    //             headers: {\n    //                 Accept: 'application/json',\n    //                 'Content-Type': 'application/json'\n    //             }\n    //         })\n    //             .then(res => res.json())\n    //             .then(resJson => {\n    //                 console.log('schoolhome: ', resJson)\n    //                 const update_types = resJson.data\n    //                 update_types.forEach(type => {\n    //                     if (type === 'pickup_request') {\n    //                         this.fetchPickupRequest(school_id)\n    //                     } else if(type === 'attendance') {\n    //                         this.fetchStudentAttendance()\n    //                     } else {\n    //                         this.refs[type].fetchData()\n    //                     }\n    //                 })\n    //             })\n    //             .catch(err => {\n    //                 Toast.show({\n    //                     text: '系統出差錯，請重新開ＡＰＰ',\n    //                     buttonText: 'Okay',\n    //                     position: \"top\",\n    //                     type: \"warning\",\n    //                     duration: 3000\n    //                 })\n    //             })\n    //     }\n    //     this.timeoutId = this.timer(school_id)\n    // }\n\n    async fetchClassIdAndName() {\n        const { school_id } = this.props.route.params\n        await fetch(`https://iejnoswtqj.execute-api.us-east-1.amazonaws.com/${ENV}/school/${school_id}`, {\n            method: 'GET',\n            headers: {\n                Accept: 'application/json',\n                'Content-Type': 'application/json'\n            }\n        })\n            .then(res => res.json())\n            .then(resJson => {\n                const { statusCode, message, data } = resJson\n                if (statusCode > 200 || message === 'Internal server error') {\n                    alert('Sorry 取得教室資料時電腦出狀況了！請截圖和與工程師聯繫 ' + message)\n                    return\n                }\n                this.setState({\n                    classes: data.classes\n                })\n                const classes = {}\n                data.classes.forEach(class_data => {\n                    const {id, name } = class_data\n                    classes[id] = {\n                        teachers: [],\n                        students: [],\n                        name\n                    }\n                })\n                this.props.fetchClassesSuccess(classes, data.admin_passcode)\n            }).catch(err => {\n                alert('Sorry 取得教室資料時電腦出狀況了！請截圖和與工程師聯繫')\n            })\n    }\n    async fetchTeacherData(school_id) {\n        const response = await get(`/school/${school_id}/teacher`)\n        const { success, statusCode, message, data } = response\n        if (!success) {\n            alert('Sorry 取得教師資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n' + message)\n            return \n        }\n        const {admins, teachers, classes} = data\n        this.props.fetchTeachersSuccess(admins, teachers, classes)\n        this.getAdminId(teachers)\n    }\n\n    getAdminId(teachers) {\n        const teacher_id_array = Object.keys(teachers)\n        for(var i = 0; i < teacher_id_array.length; i++) {\n            if (teachers[teacher_id_array[i]].name === '管理員') {\n                this.setState({\n                    admin_id: teacher_id_array[i]\n                })\n                return\n            }\n        }\n    }\n\n    async fetchStudentData(school_id) {\n        const response = await get(`/school/${school_id}/student`)\n        const { success, statusCode, message, data } = response\n        if (!success) {\n            alert('Sorry 取得學生資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n' + message)\n            return \n        }\n\n        const {students, classes} = data\n        this.props.fetchStudentsSuccess(students, classes)\n        this.props.initializeStudentWellness(Object.keys(students))\n    }\n\n    fetchPickupRequest(school_id) {\n        const query = `https://iejnoswtqj.execute-api.us-east-1.amazonaws.com/dev/attendance/pickup-request?school_id=${school_id}`\n        fetch(query, {\n            method: 'GET',\n            headers: {\n                Accept: 'application/json',\n                'Content-Type': 'application/json'\n            }\n        })\n            .then(res => res.json())\n            .then(resJson => {\n                if (resJson.data.length > 0) {\n                    this.props.addPickupRequest(resJson.data)\n                    this.props.navigation.navigate('PickupAlert', {\n                    })\n                }\n            })\n            .catch(err => {\n                alert('Sorry 取得接回告知時電腦出狀況了！請截圖和與工程師聯繫')\n            })\n    }\n\n    async fetchStudentAttendance() {\n        const { school_id } = this.props.route.params\n        const date = formatDate(new Date())\n        const response = await get(`/attendance?school_id=${school_id}&date=${date}`)\n        const { success, statusCode, message, data } = response\n        if (!success) {\n            alert('Sorry 取得學生出席資料時電腦出狀況了！請截圖和與工程師聯繫\\n\\n' + message)\n            return \n        }\n\n        const { attendance, students, present, absent } = data\n        this.props.fetchStudentAttendanceSuccess(attendance, students, present, absent)\n    }\n\n    handleEnterPasscode(passcode) {\n        console.log(passcode)\n        const { school_name, school_id } = this.props.route.params\n        const { passcodeAdminId, passcodeTeacherId, classes, teachers } = this.props\n        const { pageClicked, class_id } = this.state\n        const teacher_id = passcodeTeacherId[passcode]\n        const admin_id = passcodeAdminId[passcode]\n        console.log(admin_id)\n\n\n        if (teacher_id === undefined && admin_id === undefined) {\n            alert('密碼不正確！請截圖和與工程師聯繫')\n        } else if (admin_id !== undefined) {\n            this.setState({ showLoginNumberPad: false })\n            this.props.navigation.navigate(pageClicked, {\n                school_name, \n                school_id,\n                class_id,\n                class_name: '管理員：' + teachers[admin_id].name,\n                isAdmin: true,\n                admin_id\n            })\n        } else if (class_id !== '' && !classes[class_id].teachers.includes(teacher_id) || pageClicked === 'AdminHome') {\n            alert('Sorry 權限不合！請截圖和與工程師聯繫')\n        } else { //pageClicked === 'TeacherHome'\n            this.setState({ showLoginNumberPad: false })\n            this.props.updateViewingStatus('teacher')\n            this.props.navigation.navigate('TeacherHome', {\n                class_id,\n                class_name: classes[class_id].name,\n                isAdmin: false\n            })\n        }\n    }\n\n    hideLoginPad() {\n        this.setState({ showLoginNumberPad: false })\n    }\n\n    handleSignOut() {\n        const {loadAuth} = this.props.route.params\n        Auth.signOut()\n            .then(() => {\n                loadAuth()\n            })\n            .catch(err => console.log(err))\n    }\n\n    componentWillUnmount() {\n        // clearTimeout(this.timeoutId)\n        window.removeEventListener('offline', (e) => {\n            this.props.setConnectState(false) \n        });\n        window.removeEventListener('online', (e) => {\n            this.props.setConnectState(false) \n        });\n        this.props.clearSchoolState()\n    }\n\n    render() {\n        const { classes, showLoginNumberPad } = this.state\n        const { school_id } = this.props.route.params\n        return (\n            <View style={{ flex: 1, flexDirection: 'column' }}>\n                {showLoginNumberPad ? \n                    <LoginNumberPad\n                        handleEnterPasscode={(passcode) => this.handleEnterPasscode(passcode)}\n                        hideLoginPad={() => this.hideLoginPad()}\n                    /> : null\n                }\n\n                <View style={{ flex: 1, flexDirection: 'row' }}>\n                    <TouchableHighlight\n                        key='admin'\n                        style={{ flex: 1, backgroundColor: '#74b987', margin: 10, justifyContent: 'center' }}\n                        onPress={() => this.setState({ showLoginNumberPad: true, pageClicked: 'AdminHome' })}\n                    >\n                        <Text style={{ fontSize: 50, textAlign: 'center' }}>行政管理</Text>\n                    </TouchableHighlight>\n                    {/* <TouchableHighlight\n                        key='child_dismissal'\n                        style={{ flex: 1, backgroundColor: '#74b987', margin: 10, justifyContent: 'center' }}\n                        onPress={() => {\n                            this.props.navigation.push('DismissChildQRScan', {})\n                        }}\n                    >\n                        <Text style={{ fontSize: 50, textAlign: 'center' }}>放學</Text>\n                    </TouchableHighlight> */}\n                </View>\n                <TouchableHighlight\n                    key='attendance_page'\n                    style={{ flex: 1, backgroundColor: '#74b987', margin: 10, justifyContent: 'center' }}\n                    onPress={() => {\n                        this.props.navigation.push('AttendancePage', {\n                            school_id\n                        })\n                    }}\n                >\n                    <Text style={{ fontSize: 80, textAlign: 'center' }}>出席/打卡</Text>\n                </TouchableHighlight>\n                <View style={{ flex: 3 }}>\n                    {classes.map((class_data) => {\n                        if (class_data.name === '管理員') return null\n                        return(\n                            <TouchableHighlight\n                                key={class_data.id}\n                                style={{ \n                                    flex: 1,\n                                    backgroundColor: '#74b987', \n                                    margin: 10,\n                                    justifyContent: 'center'\n                                }}\n                                onPress={() => this.setState({\n                                    showLoginNumberPad: true,\n                                    pageClicked: 'TeacherHome',\n                                    class_id: class_data.id\n                                })}\n                            >\n                                <Text style={{ fontSize: 80, textAlign: 'center' }}>{class_data.name}</Text>\n                            </TouchableHighlight>\n                        )\n                    })}\n                </View>\n            </View>\n        )\n    }\n}\n\nconst mapStateToProps = (state) => {\n    return {\n        pick_up_request: state.school.pick_up_request,\n        passcodeAdminId: state.school.passcodeAdminId,\n        passcodeTeacherId: state.school.passcodeTeacherId,\n        classes: state.school.classes,\n        teachers: state.school.teachers,\n        viewing_status: state.school.viewing_status,\n        isConnected: state.school.isConnected\n    }\n}\n\nconst mapDispatchToProps = (dispatch) => {\n    return {\n        ...bindActionCreators({\n            setConnectState,\n            fetchClassesSuccess, \n            fetchTeachersSuccess, \n            fetchStudentsSuccess,\n            initializeStudentWellness,\n            addPickupRequest,\n            clearSchoolState,\n            updateViewingStatus,\n            fetchStudentAttendanceSuccess\n        }, dispatch)\n    }\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps) (SchoolHome)"]},"metadata":{},"sourceType":"module"}